<!--
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated from a template.
//
//     Manual changes to this file may cause unexpected behavior in your application.
//     Manual changes to this file will be overwritten if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
-->

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@attribute [Authorize]
@inject HttpClient Http
@inject IApiService ApiSvc
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IStringLocalizer<App> Localize
@inject IMatToaster Toaster


<div id="courses-cmpt">
	<Overlay @ref="courseOverlay">
	@if (!string.IsNullOrWhiteSpace(error))
	{        
		<div class="overlay-error">@error</div>
	}
	</Overlay>

	<!-- AuthorizeView allows us to only show sections of the page -->
	<!-- based on the security on the current user -->
	<AuthorizeView>
		<!-- Show this section if the user is logged in -->
		<Authorized>

			<MatFAB Class="app-fab--absolute" Icon="@MatIconNames.Favorite"></MatFAB>

			@if (courses == null)
			{
				<Busy />
			}
			else
			{
				if (canAddCourse)
				{
					<div class="new-area">
						<!-- Add a new course -->
						<MatButton Unelevated="true" @onclick="AddNewCourse" title="@(Localize["Add New Course"])">@Localize["Add New Course"]</MatButton>
					</div>
				}

				if (canViewCourse && courses.Count() > 0)
				{
					<CourseList Courses=@courses 
							IsAdmin=@isAdmin 
							CanUpdate=@canUpdateCourse 
							OnSelectionChanged=@SelectionChangedEvent 
							OnEdit=@EditCourse 
					/>
				}
			}

			@if (showPopup)
			{
				<div>
					<CourseEditDialog FormData=@formData 
							DialogIsOpen=@dialogIsOpen 
							OnSave=@SaveCourse 
							OnDelete=@DeleteCourse
							OnCancel=@CancelCourse
							CanView=@canViewCourse 
							CanAdd=@canAddCourse 
							CanUpdate=@canUpdateCourse 
							CanDelete=@canDeleteCourse

					/>
				</div>
			}
	
		<!-- +navigations -->
		<!-- -navigations -->

		</Authorized>
		<!-- Show this section if the user is not logged in -->
		<NotAuthorized>
			<p>You're not signed in.</p>
		</NotAuthorized>
	</AuthorizeView>

	<SnackBarMessage @ref="snackBarAdded" IsOpen="isAdded" Message="@(Localize["Congratualtions New Course Added Successfully"])" />
	<SnackBarMessage @ref="snackBarUpdated" IsOpen="isUpdated" Message="@(Localize["Wow! a Course Updated Successfully"])" />
	<SnackBarMessage @ref="snackBarDeleted" IsOpen="isDeleted" Message="@(Localize["Eh! you deleted a Course"])" />
</div>

@code {
    string apiRootUrl = "/api1";

	Overlay courseOverlay;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private System.Security.Claims.ClaimsPrincipal User;

    bool isOwner;
    bool isAdmin;
	bool isManager;
    bool isTeacher;
    bool canViewCourse, canAddCourse, canUpdateCourse, canDeleteCourse;

    bool isAdded, isUpdated, isDeleted;
	bool showTracker;

    bool dialogIsOpen = false;
    CourseDto dialogData = null;

    string toastMessage;
	string error;

    SnackBarMessage snackBarAdded;
    SnackBarMessage snackBarUpdated;
    SnackBarMessage snackBarDeleted;

    // Stores the courses displayed in a list
    private CourseDto[] courses;
    // Stores a single course
    CourseDto formData = new CourseDto();
    // Controls if the popup is displayed
    bool showPopup = false;
    
    public string ReturnUrl
    {
        get
        {
            return NavigationManager.Uri.Replace(NavigationManager.BaseUri, "/");
        }
    }

    //<!-- StudentCourses | StudentCourse | Collectiion -->

	
    // First method to run when user navicates to this control
    protected override async Task OnInitializedAsync()
    {
		// Get the current user
        var authState = await authenticationStateTask;
        User = authState.User;

        var username = User.Identity.IsAuthenticated ? User.Identity.Name : "Anoymous";

		isOwner = username == "a1@ark.com";

		isAdmin = User.IsInRole("Administrators") || isOwner;
        isManager = User.IsInRole("Managers") || User.IsInRole("Administrators")  || isOwner;
        isTeacher = User.IsInRole("Teachers") || User.IsInRole("Managers") || User.IsInRole("Administrators")  || isOwner;
                    

		canViewCourse = canAddCourse = canUpdateCourse = canDeleteCourse = isAdmin;
		canViewCourse = canAddCourse = canUpdateCourse = isManager;
		canViewCourse = canAddCourse = isTeacher;

        if (User.Identity != null)
        {
            try
            {
				// <!-- StudentCourses | StudentCourse | Collectiion -->

            }
            catch (AccessTokenNotAvailableException exception)
            {
                exception.Redirect();
            }

            await Search();
        }
    }

	async Task Search()
	{
		if (User.Identity.IsAuthenticated)
        {
            // Make a call to get the courses
            // we don't pass the user because the server
            // side code will determine who the user is
            // from the authentication cookie

            try
            {
                courses = await ApiSvc.GetAsync<CourseDto[]>(apiRootUrl + "/Courses");

				//
				//<!-- StudentCourses | StudentCourse | Collectiion -->

            }
            catch (AccessTokenNotAvailableException exception)
            {
                exception.Redirect();
            }
        }
	}

    public void SelectionChangedEvent(object row)
    {
        if (row != null)
        {
            var selectedCourse = (CourseDto)row;
			EditCourse(selectedCourse);
        }
		this.StateHasChanged();
    }

    void AddNewCourse()
    {
        // Make new course
        formData = new CourseDto {
						// Set Id to 0 so we know it is a new record
						Id = 0
					};

        OpenDialog();

        // this.StateHasChanged();
    }

    void EditCourse(CourseDto course)
    {
        // Set the selected course
        // as the current course
        formData = course;
        // Open the Popup
        OpenDialog();
    }

    async Task SaveCourse()
    {
		error = null;
        
		// Close the Popup
        CloseDialog();
        // Get the current user
        var user = (await authenticationStateTask).User;
        // A new course will have the Id set to 0
        if (formData.Id == 0)
        {
			try
			{
				// Create new course
				// Course objNewCourse = CourseDto.AsCourseFunc(formData);

				// Save the result
				var resp = await ApiSvc.AddAsync(apiRootUrl + "/Courses", formData);

				isAdded = true;
				snackBarAdded.Show();

				toastMessage = ($"Course '{formData.Id}' added successfully");
				Toaster.Add(toastMessage, MatToastType.Info);
			}
            catch (Exception ex)
            {
                error = ex.Message;
                courseOverlay.Show();
            }
        }
        else
        {
			try
			{
				// This is an update
				var resp = await ApiSvc.UpdateAsync(apiRootUrl + "/Courses/" + Convert.ToInt32(formData.Id), formData);

				isUpdated = true;
				snackBarUpdated.Show();

				toastMessage = ($"Course '{formData.Id}' updated successfully");
				Toaster.Add(toastMessage, MatToastType.Success);
			}
            catch (Exception ex)
            {
                error = ex.Message;
                courseOverlay.Show();
            }
        }

        // Get the courses for the current user
        await Search();

        toastMessage = ($"Courses record refreshed");
        Toaster.Add(toastMessage, MatToastType.Info);
    }

    async Task DeleteCourse()
    {
		error = null;
		try
		{
			// Close the Popup
			CloseDialog();
			// Delete the course
			var resp = await ApiSvc.DeleteAsync<Course>(apiRootUrl + "/Courses/" + Convert.ToInt32(formData.Id));

			isDeleted = true;
			snackBarDeleted.Show();


			// Get the courses for the current user
			await Search();

			toastMessage = ($"Course '{formData.Id}' deleted successfully");
			Toaster.Add(toastMessage, MatToastType.Danger);
		}
        catch (Exception ex)
        {
            error = ex.Message;
            courseOverlay.Show();
        }
    }

    void CancelCourse()
    {
        CloseDialog();
    }

    void OpenDialog()
    {
        // Open the Popup
        showPopup = true;
        dialogData = null;
        dialogIsOpen = true;
    }

    void CloseDialog()
    {
        // close the Popup
        showPopup = false;
        dialogIsOpen = false;
    }




}

